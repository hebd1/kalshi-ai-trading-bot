name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - "v*"
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_IMAGE: elihebdon/kalshi-ai-trading-bot
  PYTHON_VERSION: '3.12'

permissions:
  contents: read

jobs:
  verify:
    name: Verify and Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Run verification tests
      run: |
        python run_tests.py --ci

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: verify
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-labels: ${{ steps.meta.outputs.labels }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
        
    - name: Extract Docker metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=tag
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [verify, build-docker]
    if: |
      always() && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/master' &&
      needs.verify.result == 'success' &&
      needs.build-docker.result == 'success'
    
    steps:
    - name: Deploy to Synology NAS
      uses: appleboy/ssh-action@master
      with:
        host: helloadrastea.synology.me
        username: deimos
        port: 2222
        key: ${{ secrets.ADRASTEA_SSH_KEY }}
        script: |
          export PATH=$PATH:/usr/local/bin
          
          echo "=== Kalshi Trading Bot Deployment Started ==="
          echo "Connected to $(hostname)"
          echo "Current working directory: $(pwd)"
          echo "Timestamp: $(date)"
          
          echo "=== Checking Docker Status ==="
          docker --version
          docker ps | head -5
          
          echo "=== Managing existing container ==="
          # Check if container exists and is running
          if docker ps -q -f name=kalshi-trading-bot | grep -q .; then
            echo "ðŸ›‘ Stopping running container..."
            docker stop kalshi-trading-bot || echo "Warning: Failed to stop container"
            echo "Container stopped successfully"
          else
            echo "â„¹ï¸ No running container found"
          fi
          
          # Check if container exists (stopped)
          if docker ps -a -q -f name=kalshi-trading-bot | grep -q .; then
            echo "ðŸ—‘ï¸ Removing existing container..."
            docker rm kalshi-trading-bot || echo "Warning: Failed to remove container"
            echo "Container removed successfully"
          else
            echo "â„¹ï¸ No existing container to remove"
          fi
          
          echo "=== Pulling latest image ==="
          if docker pull ${{ env.DOCKER_IMAGE }}:latest; then
            echo "âœ… Successfully pulled latest image"
          else
            echo "âŒ Failed to pull image"
            exit 1
          fi
          
          echo "=== Starting new dual-service container (trading bot + dashboard) ==="
          if docker run -d \
            --name kalshi-trading-bot \
            --restart unless-stopped \
            -p 8501:8501 \
            -v /volume3/docker/kalshi-trading-bot/logs:/app/logs:rw \
            -v /volume3/docker/kalshi-trading-bot/shared:/app/shared:rw \
            -v /volume3/docker/kalshi-trading-bot/keys/kalshi_private_key.pem:/app/keys/kalshi_private_key.pem:ro \
            -v /volume3/docker/kalshi-trading-bot/keys/kalshi_private_key.prod.pem:/app/keys/kalshi_private_key.prod.pem:ro \
            -v /volume3/docker/kalshi-trading-bot/.env:/app/.env:ro \
            -v /volume3/docker/kalshi-trading-bot/trading_system.db:/app/trading_system.db:rw \
            -e PYTHONUNBUFFERED=1 \
            -e PYTHONPATH=/app \
            -e TZ=America/Denver \
            ${{ env.DOCKER_IMAGE }}:latest; then
            echo "âœ… Container started successfully"
          else
            echo "âŒ Failed to start container"
            echo "Container logs:"
            docker logs kalshi-trading-bot 2>&1 || echo "No logs available"
            exit 1
          fi
          
          echo "=== Verifying deployment ==="
          echo "â³ Waiting for container to start..."
          sleep 10
          
          if docker ps | grep kalshi-trading-bot | grep -q "Up"; then
            echo "âœ… Dual-service deployment successful!"
            echo ""
            echo "ðŸ”— **Access Points:**"
            echo "ðŸ“Š Dashboard: http://helloadrastea.synology.me:8501"
            echo "ðŸ¤– Trading Bot: Running in background"
            echo ""
            echo "ðŸ“‹ **Container Status:**"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep kalshi-trading-bot || echo "Status check failed"
            echo ""
            echo "ðŸ“œ **Recent Logs:**"
            docker logs --tail 20 kalshi-trading-bot 2>&1 || echo "No logs available yet"
          else
            echo "âŒ Deployment verification failed"
            echo ""
            echo "ðŸ” **Debugging Info:**"
            echo "Container status:"
            docker ps -a | grep kalshi-trading-bot || echo "No container found"
            echo ""
            echo "Full logs:"
            docker logs kalshi-trading-bot 2>&1 || echo "No logs available"
            exit 1
          fi
          
          echo ""
          echo "=== ðŸŽ‰ Kalshi Trading Bot Deployment Completed Successfully ==="

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [verify, build-docker, deploy]
    if: always()
    
    steps:
    - name: Determine overall status
      id: status
      run: |
        if [[ "${{ needs.deploy.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=âœ… Kalshi Trading Bot deployment completed successfully" >> $GITHUB_OUTPUT
        elif [[ "${{ needs.verify.result }}" == "failure" ]]; then
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ Verification failed - deployment skipped" >> $GITHUB_OUTPUT
        elif [[ "${{ needs.build-docker.result }}" == "failure" ]]; then
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ Docker build failed - deployment skipped" >> $GITHUB_OUTPUT
        else
          echo "status=skipped" >> $GITHUB_OUTPUT
          echo "message=âš ï¸ Pipeline completed with warnings or was skipped" >> $GITHUB_OUTPUT
        fi
        
    - name: Report status
      run: |
        echo "### Kalshi Trading Bot Pipeline Status: ${{ steps.status.outputs.status }}"
        echo "${{ steps.status.outputs.message }}"
        echo ""
        echo "**Job Results:**"
        echo "- Verify: ${{ needs.verify.result }}"
        echo "- Docker Build: ${{ needs.build-docker.result }}"
        echo "- Deploy: ${{ needs.deploy.result }}"